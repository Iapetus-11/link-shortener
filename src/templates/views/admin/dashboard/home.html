{% extends "views/base.html" %}

{% block head %}
<style>
    .layout {
        display: flex;
        gap: 2rem;
    }

    .layout>section {
        width: 50%;
        max-width: 50%;
    }

    @media (max-width: 74rem) {
        .layout {
            flex-direction: column;
        }

        .layout>section {
            width: 100%;
        }
    }

    .platforms-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .platform-card {
        transition: border 200ms;
        border: 1px transparent solid;
        display: block;
    }

    .selected-platform-card {
        border: 1px #629bde solid;
    }

    .platform-card:visited {
        color: white;
    }

    .platform-card:hover {
        border: 1px #629bde solid;
    }

    .clickable-text-with-icon {
        display: flex;
        align-items: center;

        /* Increase clickable area */
        padding: 0.5rem;
        margin: -0.5rem;
    }

    .clickable-text-with-icon samp {
        font-style: monospace;
    }

    .clickable-text-with-icon .icon {
        opacity: 0;
        height: 1rem;
        width: 1rem;
        transition: opacity 100ms;
        margin-left: 0.125rem;
    }

    .clickable-text-with-icon:hover .icon {
        opacity: 0.8;
    }

    .clickable-text-with-icon:active .icon {
        opacity: 1;
    }

    .card-action-button {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
        height: 32px;
        padding: 0 0.5rem;
    }

    .card-action-button .icon {
        display: flex;
        align-items: center;
        height: 1rem;
        width: 1rem;
        margin-right: 0.25rem;
    }

    .reset-key-button .icon {
        transition: transform 200ms;
    }

    .reset-key-button:hover .icon {
        transform: rotate(15deg);
    }

    @keyframes spin {
        0% {
            rotate: 0;
        }

        100% {
            rotate: 1turn;
        }
    }

    .animate-spin {
        animation: spin 400ms linear infinite;
    }

    /* --- icons ------------------------ */
    .material-symbols--content-copy-outline {
        display: inline-block;
        width: 24px;
        height: 24px;
        --svg: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23000' d='M9 18q-.825 0-1.412-.587T7 16V4q0-.825.588-1.412T9 2h9q.825 0 1.413.588T20 4v12q0 .825-.587 1.413T18 18zm0-2h9V4H9zm-4 6q-.825 0-1.412-.587T3 20V6h2v14h11v2zm4-6V4z'/%3E%3C/svg%3E");
        background-color: currentColor;
        -webkit-mask-image: var(--svg);
        mask-image: var(--svg);
        -webkit-mask-repeat: no-repeat;
        mask-repeat: no-repeat;
        -webkit-mask-size: 100% 100%;
        mask-size: 100% 100%;
    }

    .material-symbols--refresh-rounded {
        display: inline-block;
        width: 24px;
        height: 24px;
        --svg: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23000' d='M12 20q-3.35 0-5.675-2.325T4 12t2.325-5.675T12 4q1.725 0 3.3.712T18 6.75V5q0-.425.288-.712T19 4t.713.288T20 5v5q0 .425-.288.713T19 11h-5q-.425 0-.712-.288T13 10t.288-.712T14 9h3.2q-.8-1.4-2.187-2.2T12 6Q9.5 6 7.75 7.75T6 12t1.75 4.25T12 18q1.7 0 3.113-.862t2.187-2.313q.2-.35.563-.487t.737-.013q.4.125.575.525t-.025.75q-1.025 2-2.925 3.2T12 20'/%3E%3C/svg%3E");
        background-color: currentColor;
        -webkit-mask-image: var(--svg);
        mask-image: var(--svg);
        -webkit-mask-repeat: no-repeat;
        mask-repeat: no-repeat;
        -webkit-mask-size: 100% 100%;
        mask-size: 100% 100%;
    }

    .material-symbols--add {
        display: inline-block;
        width: 24px;
        height: 24px;
        --svg: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23000' d='M11 13H5v-2h6V5h2v6h6v2h-6v6h-2z'/%3E%3C/svg%3E");
        background-color: currentColor;
        -webkit-mask-image: var(--svg);
        mask-image: var(--svg);
        -webkit-mask-repeat: no-repeat;
        mask-repeat: no-repeat;
        -webkit-mask-size: 100% 100%;
        mask-size: 100% 100%;
    }

    .material-symbols--arrow-outward-rounded {
        display: inline-block;
        width: 24px;
        height: 24px;
        --svg: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23000' d='m16 8.4l-8.9 8.9q-.275.275-.7.275t-.7-.275t-.275-.7t.275-.7L14.6 7H7q-.425 0-.712-.288T6 6t.288-.712T7 5h10q.425 0 .713.288T18 6v10q0 .425-.288.713T17 17t-.712-.288T16 16z'/%3E%3C/svg%3E");
        background-color: currentColor;
        -webkit-mask-image: var(--svg);
        mask-image: var(--svg);
        -webkit-mask-repeat: no-repeat;
        mask-repeat: no-repeat;
        -webkit-mask-size: 100% 100%;
        mask-size: 100% 100%;
    }

    .material-symbols--delete-outline {
        display: inline-block;
        width: 24px;
        height: 24px;
        --svg: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23000' d='M7 21q-.825 0-1.412-.587T5 19V6H4V4h5V3h6v1h5v2h-1v13q0 .825-.587 1.413T17 21zM17 6H7v13h10zM9 17h2V8H9zm4 0h2V8h-2zM7 6v13z'/%3E%3C/svg%3E");
        background-color: currentColor;
        -webkit-mask-image: var(--svg);
        mask-image: var(--svg);
        -webkit-mask-repeat: no-repeat;
        mask-repeat: no-repeat;
        -webkit-mask-size: 100% 100%;
        mask-size: 100% 100%;
    }
</style>
{% endblock %}

{% block body %}
<div class="layout">
    <!-- Platforms -->
    <section>
        <h2 style="font-size: 2rem; font-weight: 600; margin-bottom: 1.25rem;">Platforms</h2>
        <p style="display: block; margin-bottom: 0.5rem; font-size: 0.8rem;">
            Authentication with the API uses the basic auth scheme where the platform ID is the
            username and the platform API key is the password. Example:
        </p>
        <code
            style="display: block; font-size: 0.8rem; opacity: 0.8;"
            class="card"
        >
            headers = {<br>
                &emsp;&ensp;"Authorization": "Basic " + base64_encode(platform_id + ":" + api_key)<br>
            }
        </code>

        <form
            action="create-platform/"
            method="post"
            style="margin-top: 1.75rem; justify-content: end; display: flex; width: 100%; gap: 0.5rem;"
            onsubmit="this.querySelector('.icon').classList.add('animate-spin');"
        >
            <input
                type="text"
                name="name"
                required
                minlength="2"
                maxlength="28"
                placeholder="Enter platform name..."
                style="width: 100%; max-width: 16rem;"
                class="text-input"
            >

            <button
                type="submit"
                class="button"
                style="display: flex; align-items: center;"
            >
                <span
                    class="icon material-symbols--add"
                    style="margin-right: 0.125rem; margin-left: -0.25rem; width: 1.25rem; height: 1.25rem;"
                ></span>
                Create
            </button>
        </form>

        <ul
            class="platforms-list"
            style="margin-top: 1rem;"
        >
            {% for platform in platforms %}
            <li>
                <a
                    {%
                    if
                    selected_platform.is_some()
                    &&
                    selected_platform.unwrap().id==platform.id
                    %}
                    href="?"
                    {%
                    else
                    %}
                    href="?platform={{ platform.id }}"
                    {%
                    endif
                    %}
                    class="card platform-card {% if selected_platform.is_some() && platform.id == selected_platform.unwrap().id %}selected-platform-card{% endif %}"
                >
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <h3
                                style="font-size: 1.5rem; margin-bottom: 0.65rem; font-weight: 600;">
                                {{ platform.name }}
                            </h3>

                            <button
                                type="button"
                                onclick="navigator.clipboard.writeText('{{ platform.id }}'); event.preventDefault();"
                                class="clickable-text-with-icon"
                                style="color: #bbc4c2;"
                            >
                                <span>ID: <samp>{{ platform.id }}</samp></span>
                                <span class="icon material-symbols--content-copy-outline">
                                </span>
                            </button>
                        </div>

                        <div
                            style="display: flex; flex-direction: column; justify-content: center; align-items: end; gap: 0.4rem; margin-top: -0.5rem; margin-bottom: -0.5rem; margin-right: -0.5rem;"
                        >
                            <form
                                action="reset-api-key/"
                                method="post"
                            >
                                <input
                                    type="hidden"
                                    name="platform_id"
                                    value="{{ platform.id }}"
                                >

                                <button
                                    type="submit"
                                    class="button card-action-button reset-key-button"
                                    onclick="this.querySelector('span').classList.add('animate-spin'); event.stopPropagation();"
                                >
                                    <span class="icon material-symbols--refresh-rounded"></span>
                                    Reset API Key
                                </button>
                            </form>

                            <form
                                method="post"
                                action="delete-platform/"
                            >
                                <input
                                    type="hidden"
                                    name="platform_id"
                                    value="{{ platform.id }}"
                                >

                                <button
                                    type="submit"
                                    class="button card-action-button"
                                    onclick="this.querySelector('span').classList.add('animate-spin');"
                                >
                                    <span class="icon material-symbols--delete-outline"></span>
                                    Delete
                                </button>
                            </form>
                        </div>
                    </div>

                    {% match state.action_result %}
                    {% when Some with (PageActionResult::ShowNewPlatformApiKey {
                    platform_id,
                    api_key,
                    })
                    %}
                    {%if platform_id == &platform.id %}
                    <div>
                        <div style="margin-top: 0.5rem; margin-bottom: 0.125rem;">
                            API Key (will only be shown once):
                        </div>

                        <button
                            type="button"
                            onclick="navigator.clipboard.writeText('{{ api_key }}'); event.preventDefault();"
                            class="clickable-text-with-icon"
                            style="font-size: 0.8rem; color: #bbc4c2;"
                        >
                            <samp>{{ api_key }}</samp>
                            <span class="icon material-symbols--content-copy-outline"></span>
                        </button>
                    </div>
                    {% endif %}
                    {% else %}
                    {% endmatch %}
                </a>
            </li>
            {% endfor %}
        </ul>
    </section>

    <!-- Links -->
    <section>
        <h2 style="font-size: 2rem; font-weight: 600; margin-bottom: 1rem; text-align: right;">
            {% if let Some(selected_platform) = selected_platform %}{{ selected_platform.name }}{%
            endif %} Links
        </h2>

        {% if selected_platform.is_some() %}
        <form
            action="create-link/"
            method="post"
            style="margin-top: 1.75rem; display: flex; flex-direction: column; width: 100%; gap: 0.5rem;"
            onsubmit="this.querySelector('.icon').classList.add('animate-spin');"
        >
            <input
                type="hidden"
                name="platform_id"
                value="{{ selected_platform.unwrap().id }}"
            >

            <input
                type="url"
                name="url"
                required
                minlength="7"
                maxlength="1000"
                placeholder="Enter link URL..."
                class="text-input"
            >

            <textarea
                name="metadata"
                class="text-input"
                placeholder="Enter link metadata JSON (optional)..."
                style="height: 3rem; resize: vertical;"
            ></textarea>

            <div style="display: flex; gap: 0.5rem; width: 100%;">
                <input
                    type="text"
                    name="slug"
                    minlength="2"
                    maxlength="28"
                    placeholder="Enter link slug / short..."
                    title="Slug must only contain alphanumeric characters, dashes, and underscores"
                    pattern="[\w\-]{2,28}"
                    class="text-input"
                    style="width: 100%;"
                >

                <button
                    type="submit"
                    class="button"
                    style="display: flex; align-items: center; width: fit-content;"
                >
                    <span
                        class="icon material-symbols--add"
                        style="margin-right: 0.125rem; margin-left: -0.25rem; width: 1.25rem; height: 1.25rem;"
                    ></span>
                    Create
                </button>
            </div>
        </form>
        {% endif %}

        {% if selected_platform.is_none() %}
        <p style="margin-top: 4rem; width: 100%; text-align: center;">
            Select a platform from the left panel to create or view links.
        </p>
        {% else if links.len() > 0 %}
        <ul style="margin-top: 1rem; display: flex; flex-direction: column; gap: 1rem;">
            {% for link in links %}
            <li class="card">
                <div style="display: flex; justify-content: space-between;">
                    <div style="width: 100%;">
                        <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; font-weight: 600;">
                            <button
                                type="button"
                                onclick="navigator.clipboard.writeText(`${window.origin}/{{ link.slug }}`)"
                                class="clickable-text-with-icon"
                                style="margin-bottom: -1rem;"
                            >
                                /{{ link.slug }}
                                <span
                                    class="icon material-symbols--content-copy-outline"
                                    style="height: 1.5rem; width: 1.5rem;"
                                ></span>
                            </button>
                        </h3>

                        <a
                            class="clickable-text-with-icon"
                            href="{{ link.url }}"
                            target="_blank"
                            rel="noreferrer"
                            style="color: #bbc4c2;"
                        >
                            <span style="text-overflow: ellipsis;">
                                <samp>{{ link.url }}</samp>
                            </span>
                            <span class="icon material-symbols--arrow-outward-rounded"></span>
                        </a>
                    </div>

                    <div style="display: flex; flex-direction: column; justify-content: start; margin-top: -0.25rem; margin-bottom: -0.25rem; margin-right: -0.25rem;">
                        <form
                            method="post"
                            action="delete-link/"
                        >
                            <input
                                type="hidden"
                                name="link_slug"
                                value="{{ link.slug }}"
                            >

                            <button
                                type="submit"
                                class="button card-action-button"
                                onclick="this.querySelector('span').classList.add('animate-spin');"
                            >
                                <span class="icon material-symbols--delete-outline"></span>
                                Delete
                            </button>
                        </form>
                    </div>
                </div>

                {% if let Some(metadata) = link.metadata %}
                <code
                    style="display: block; white-space: pre; text-align: left; background-color: #354659; color: #bbc4c2; padding: 0.75rem; border-radius: 0.25rem; cursor: text; margin-top: 0.75rem;"
                >{{
                    metadata.to_json_string_pretty().unwrap()
                }}</code>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p style="margin-top: 6rem; width: 100%; text-align: center;">
            This platform has no links, create one above
        </p>
        {% endif %}
    </section>
</div>
{% endblock %}
